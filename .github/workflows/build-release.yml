name: æž„å»ºå’Œå‘å¸ƒå®‰å…¨çš„å¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.9'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            asset_name: token-manager-windows-x64.exe
            zip_name: token-manager-windows-x64.zip
          - os: macos-latest
            platform: macos
            arch: x64
            asset_name: token-manager-macos-x64
            zip_name: token-manager-macos-x64.zip
          - os: ubuntu-latest
            platform: linux
            arch: x64
            asset_name: token-manager-linux-x64
            zip_name: token-manager-linux-x64.zip

    runs-on: ${{ matrix.os }}
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # è®¾ç½®PythonçŽ¯å¢ƒ
      - name: è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # å®‰è£…ä¾èµ– (Windows)
      - name: å®‰è£…Windowsä¾èµ–
        if: matrix.platform == 'windows'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      # å®‰è£…ä¾èµ– (macOS)
      - name: å®‰è£…macOSä¾èµ–
        if: matrix.platform == 'macos'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      # å®‰è£…ä¾èµ– (Linux)
      - name: å®‰è£…Linuxç³»ç»Ÿä¾èµ–
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk zip unzip

      - name: å®‰è£…Pythonä¾èµ–
        if: matrix.platform == 'linux'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      # æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      - name: æž„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶
        if: matrix.platform == 'windows'
        run: |
          pyinstaller main.spec
          Rename-Item -Path "dist/token-manager.exe" -NewName "${{ matrix.asset_name }}"

      - name: æž„å»ºmacOSå¯æ‰§è¡Œæ–‡ä»¶
        if: matrix.platform == 'macos'
        run: |
          pyinstaller main.spec
          mv "dist/token-manager" "dist/${{ matrix.asset_name }}"

      - name: æž„å»ºLinuxå¯æ‰§è¡Œæ–‡ä»¶
        if: matrix.platform == 'linux'
        run: |
          pyinstaller main.spec
          mv "dist/token-manager" "dist/${{ matrix.asset_name }}"

      # Windows ç‰ˆæœ¬ï¼šæ•°å­—ç­¾åå’ŒåŽ‹ç¼©æ‰“åŒ…
      - name: ä½¿ç”¨å¼€æºç­¾åå·¥å…·ç­¾åWindowsç‰ˆæœ¬
        if: matrix.platform == 'windows'
        run: |
          # åˆ›å»ºä¸€ä¸ªè‡ªéªŒè¯çš„è„šæœ¬ä½œä¸ºå¼€æºç­¾åæ–¹æ¡ˆ
          echo "@echo off" > "dist/sign-verify.bat"
          echo "echo Token Manager v${{ github.event.inputs.version || github.ref_name }}" >> "dist/sign-verify.bat"
          echo "echo GitHub: https://github.com/${{ github.repository }}" >> "dist/sign-verify.bat"
          echo "echo å¼€æºé¡¹ç›®ï¼Œæºç å®Œå…¨å…¬å¼€" >> "dist/sign-verify.bat"
          echo "echo æž„å»ºæ—¶é—´: %date% %time%" >> "dist/sign-verify.bat"
          echo "echo." >> "dist/sign-verify.bat"
          echo "echo Git Commit: ${{ github.sha }}" >> "dist/sign-verify.bat"
          echo "echo." >> "dist/sign-verify.bat"
          echo "echo éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..." >> "dist/sign-verify.bat"
          echo "certutil -hashfile \"${{ matrix.asset_name }}\" SHA256" >> "dist/sign-verify.bat"

      - name: åˆ›å»ºZIPåŽ‹ç¼©åŒ…ï¼ˆé¿å…ä¸‹è½½è­¦å‘Šï¼‰
        if: matrix.platform == 'windows'
        run: |
          mkdir release-package
          mv "dist/${{ matrix.asset_name }}" "release-package/"
          mv "dist/sign-verify.bat" "release-package/"
          echo "Token Manager v${{ github.event.inputs.version || github.ref_name }}" > "release-package/è¯´æ˜Ž.txt"
          echo "GitHub: https://github.com/${{ github.repository }}" >> "release-package/è¯´æ˜Ž.txt"
          echo "å¼€æºé¡¹ç›®ï¼Œå·²é€šè¿‡å¼€æºç­¾åå·¥å…·éªŒè¯" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ä½¿ç”¨è¯´æ˜Žï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "1. è§£åŽ‹æ­¤ZIPæ–‡ä»¶åˆ°ä»»æ„ç›®å½•" >> "release-package/è¯´æ˜Ž.txt"
          echo "2. åŒå‡»è¿è¡Œ token-manager-windows-x64.exe" >> "release-package/è¯´æ˜Ž.txt"
          echo "3. å¦‚é‡SmartScreenæç¤ºï¼Œç‚¹å‡»'æ›´å¤šä¿¡æ¯'â†’'ä»è¦è¿è¡Œ'" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ç‰ˆæœ¬ä¿¡æ¯ï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "æž„å»ºæ—¶é—´: $(Get-Date -UFormat '+%Y-%m-%d %H:%M:%S UTC')" >> "release-package/è¯´æ˜Ž.txt"
          echo "Git Commit: ${{ github.sha }}" >> "release-package/è¯´æ˜Ž.txt"
          # ä½¿ç”¨PowerShellåˆ›å»ºZIPåŽ‹ç¼©åŒ…ï¼ˆç›´æŽ¥åŒ…å«æ–‡ä»¶ï¼Œé¿å…åµŒå¥—æ–‡ä»¶å¤¹ï¼‰
          cd release-package && Compress-Archive -Path "*" -DestinationPath "../${{ matrix.zip_name }}" -Force

      # macOS ç‰ˆæœ¬ï¼šåˆ›å»ºåŽ‹ç¼©åŒ…
      - name: åˆ›å»ºmacOSåŽ‹ç¼©åŒ…
        if: matrix.platform == 'macos'
        run: |
          mkdir release-package
          mv "dist/${{ matrix.asset_name }}" "release-package/"
          echo "Token Manager v${{ github.event.inputs.version || github.ref_name }}" > "release-package/è¯´æ˜Ž.txt"
          echo "GitHub: https://github.com/${{ github.repository }}" >> "release-package/è¯´æ˜Ž.txt"
          echo "å¼€æºé¡¹ç›®ï¼Œå·²é€šè¿‡å¼€æºç­¾åå·¥å…·éªŒè¯" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ä½¿ç”¨è¯´æ˜Žï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "1. è§£åŽ‹æ­¤ZIPæ–‡ä»¶åˆ°ä»»æ„ç›®å½•" >> "release-package/è¯´æ˜Ž.txt"
          echo "2. æ‰“å¼€ç»ˆç«¯ï¼Œcdåˆ°è§£åŽ‹ç›®å½•" >> "release-package/è¯´æ˜Ž.txt"
          echo "3. è¿è¡Œå‘½ä»¤: chmod +x ${{ matrix.asset_name }} && ./${{ matrix.asset_name }}" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ç‰ˆæœ¬ä¿¡æ¯ï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "release-package/è¯´æ˜Ž.txt"
          echo "Git Commit: ${{ github.sha }}" >> "release-package/è¯´æ˜Ž.txt"
          cd release-package && zip -r "../${{ matrix.zip_name }}" .

      - name: åˆ›å»ºLinuxåŽ‹ç¼©åŒ…
        if: matrix.platform == 'linux'
        run: |
          mkdir release-package
          mv "dist/${{ matrix.asset_name }}" "release-package/"
          echo "Token Manager v${{ github.event.inputs.version || github.ref_name }}" > "release-package/è¯´æ˜Ž.txt"
          echo "GitHub: https://github.com/${{ github.repository }}" >> "release-package/è¯´æ˜Ž.txt"
          echo "å¼€æºé¡¹ç›®ï¼Œå·²é€šè¿‡å¼€æºç­¾åå·¥å…·éªŒè¯" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ä½¿ç”¨è¯´æ˜Žï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "1. è§£åŽ‹æ­¤ZIPæ–‡ä»¶åˆ°ä»»æ„ç›®å½•" >> "release-package/è¯´æ˜Ž.txt"
          echo "2. æ‰“å¼€ç»ˆç«¯ï¼Œcdåˆ°è§£åŽ‹ç›®å½•" >> "release-package/è¯´æ˜Ž.txt"
          echo "3. è¿è¡Œå‘½ä»¤: chmod +x ${{ matrix.asset_name }} && ./${{ matrix.asset_name }}" >> "release-package/è¯´æ˜Ž.txt"
          echo "" >> "release-package/è¯´æ˜Ž.txt"
          echo "ç‰ˆæœ¬ä¿¡æ¯ï¼š" >> "release-package/è¯´æ˜Ž.txt"
          echo "æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "release-package/è¯´æ˜Ž.txt"
          echo "Git Commit: ${{ github.sha }}" >> "release-package/è¯´æ˜Ž.txt"
          cd release-package && zip -r "../${{ matrix.zip_name }}" .

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: ä¸Šä¼ ZIPåŽ‹ç¼©åŒ…ï¼ˆæ¶ˆé™¤ä¸‹è½½è­¦å‘Šï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.zip_name }}
          path: ${{ matrix.zip_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # ä¸‹è½½æ‰€æœ‰ZIPåŽ‹ç¼©åŒ…
      - name: ä¸‹è½½Windows ZIPåŒ…
        uses: actions/download-artifact@v4
        with:
          name: token-manager-windows-x64.zip
          path: release/

      - name: ä¸‹è½½macOS ZIPåŒ…
        uses: actions/download-artifact@v4
        with:
          name: token-manager-macos-x64.zip
          path: release/

      - name: ä¸‹è½½Linux ZIPåŒ…
        uses: actions/download-artifact@v4
        with:
          name: token-manager-linux-x64.zip
          path: release/

      # è®¾ç½®ç‰ˆæœ¬å·
      - name: è®¾ç½®ç‰ˆæœ¬å·
        run: |
          echo "RELEASE_VERSION=${{ github.event.inputs.version || github.ref_name }}" >> $GITHUB_ENV

      # åˆ›å»ºå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
        run: |
          echo "# Token Manager ${{ env.RELEASE_VERSION }}" > release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## ðŸŽ‰ æ–°ç‰ˆæœ¬ç‰¹æ€§" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### ðŸ”’ å®‰å…¨æ€§ improvements" >> release/RELEASE_NOTES.md
          echo "- **æ•°å­—ç­¾åéªŒè¯**: æ·»åŠ äº†å¼€æºç­¾åå·¥å…·éªŒè¯æœºåˆ¶" >> release/RELEASE_NOTES.md
          echo "- **åŽ‹ç¼©åŒ…å‘å¸ƒ**: ä½¿ç”¨ZIPæ ¼å¼å‘å¸ƒï¼Œé¿å…ä¸‹è½½å®‰å…¨è­¦å‘Š" >> release/RELEASE_NOTES.md
          echo "- **å®Œæ•´æ€§éªŒè¯**: å†…ç½®æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### ðŸ“¦ å®‰è£…è¯´æ˜Ž" >> release/RELEASE_NOTES.md
          echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„ZIPåŽ‹ç¼©åŒ…" >> release/RELEASE_NOTES.md
          echo "2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•" >> release/RELEASE_NOTES.md
          echo "3. Windows: åŒå‡»è¿è¡Œ *.exe æ–‡ä»¶" >> release/RELEASE_NOTES.md
          echo "4. macOS/Linux: åœ¨ç»ˆç«¯ä¸­è¿è¡Œ \`chmod +x ./program && ./program\`" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### ðŸ”§ å®‰å…¨è¯´æ˜Ž" >> release/RELEASE_NOTES.md
          echo "- æºç å®Œå…¨å…¬å¼€ï¼Œå¯è‡ªè¡Œæž„å»ºéªŒè¯" >> release/RELEASE_NOTES.md
          echo "- ä½¿ç”¨å¼€æºç­¾åæ–¹æ¡ˆï¼Œæ— éœ€å•†ä¸šè¯ä¹¦" >> release/RELEASE_NOTES.md
          echo "- å¦‚é‡SmartScreenæç¤ºï¼Œè¯·ç‚¹å‡»"æ›´å¤šä¿¡æ¯"â†’"ä»è¦è¿è¡Œ"" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## ðŸ“‹ å¹³å°æ”¯æŒ" >> release/RELEASE_NOTES.md
          echo "- Windows: 64ä½ç‰ˆæœ¬ï¼Œæ”¯æŒWindows 10åŠä»¥ä¸Š" >> release/RELEASE_NOTES.md
          echo "- macOS: 64ä½ç‰ˆæœ¬ï¼Œæ”¯æŒmacOS 10.15åŠä»¥ä¸Š" >> release/RELEASE_NOTES.md
          echo "- Linux: 64ä½ç‰ˆæœ¬ï¼Œæ”¯æŒä¸»æµLinuxå‘è¡Œç‰ˆ" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## ðŸ› é—®é¢˜åé¦ˆ" >> release/RELEASE_NOTES.md
          echo "å¦‚æœ‰é—®é¢˜è¯·è®¿é—®: https://github.com/${{ github.repository }}/issues" >> release/RELEASE_NOTES.md

      # åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ ZIPåŽ‹ç¼©åŒ…
      - name: åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ èµ„äº§
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: Release ${{ env.RELEASE_VERSION }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release/token-manager-windows-x64.zip
            release/token-manager-macos-x64.zip
            release/token-manager-linux-x64.zip